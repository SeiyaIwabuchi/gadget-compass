---
// RecentSection.astro
import { getCollection } from 'astro:content';
import RecentCard from './RecentCard.astro';

// Content Collectionsã‹ã‚‰å…¨è¨˜äº‹ã‚’å–å¾—
const allArticles = await getCollection('articles');

// æœ€æ–°è¨˜äº‹ã‚’æ—¥ä»˜é †ã§å–å¾—ï¼ˆæœ€å¤§3ä»¶ï¼‰
const recentArticles = allArticles
    .sort((a, b) => {
        const dateA = a.data.pubDate ? new Date(a.data.pubDate).getTime() : 0;
        const dateB = b.data.pubDate ? new Date(b.data.pubDate).getTime() : 0;
        return dateB - dateA;
    })
    .slice(0, 3);

// URLæ§‹ç¯‰ç”¨ã®ãƒ™ãƒ¼ã‚¹ãƒ‘ã‚¹
const basePath = import.meta.env.BASE_URL || '/';

// ã‚¿ã‚°ã«åŸºã¥ãçµµæ–‡å­—ãƒãƒƒãƒ”ãƒ³ã‚°
function getEmojiForTags(tags: string[]): string {
    const tagEmojiMap: Record<string, string> = {
        'ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°': 'ğŸ’»',
        'React': 'âš›ï¸',
        'JavaScript': 'ğŸŸ¨',
        'TypeScript': 'ğŸ”·',
        'ã‚µãƒ¼ãƒãƒ¼': 'ğŸ–¥ï¸',
        'Proxmox': 'ğŸ”§',
        'è‡ªå®…ãƒ©ãƒœ': 'ğŸ ',
        'ã‚ªãƒ¼ãƒ‡ã‚£ã‚ª': 'ğŸ§',
        'ãƒ¯ã‚¤ãƒ¤ãƒ¬ã‚¹': 'ğŸ“¡',
        'ãƒã‚¤ã‚ºã‚­ãƒ£ãƒ³ã‚»ãƒªãƒ³ã‚°': 'ğŸ”‡',
        'ãƒ¬ãƒ“ãƒ¥ãƒ¼': 'ğŸ“',
        'ã‚¬ã‚¸ã‚§ãƒƒãƒˆ': 'ğŸ“±',
        'AI': 'ğŸ¤–',
        'Webé–‹ç™º': 'ğŸŒ',
        'ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹': 'ğŸ—„ï¸',
        'ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£': 'ğŸ”’',
        'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯': 'ğŸŒ',
        'ã‚¯ãƒ©ã‚¦ãƒ‰': 'â˜ï¸',
        'Docker': 'ğŸ³',
        'Linux': 'ğŸ§'
    };
    
    for (const tag of tags) {
        if (tagEmojiMap[tag]) {
            return tagEmojiMap[tag];
        }
    }
    return 'ğŸ“„'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆçµµæ–‡å­—
}

// æ˜Ÿè©•ä¾¡ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°
function generateStarRating(rating: number): { fullStars: number, emptyStars: number, rating: number } {
    const fullStars = Math.floor(rating);
    const emptyStars = 5 - fullStars;
    return { fullStars, emptyStars, rating };
}

// èª­äº†æ™‚é–“ã‚’è¨ˆç®—ã™ã‚‹é–¢æ•°ï¼ˆæ–‡å­—æ•°ã‹ã‚‰æ¨å®šï¼‰
function calculateReadTime(content: string): number {
    const wordsPerMinute = 300; // æ—¥æœ¬èªã®å¹³å‡èª­æ›¸é€Ÿåº¦ï¼ˆæ–‡å­—/åˆ†ï¼‰
    const wordCount = content.length;
    return Math.max(1, Math.ceil(wordCount / wordsPerMinute));
}

// ãƒ¢ãƒƒã‚¯çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆ
function generateMockStats() {
    return {
        views: Math.floor(Math.random() * 2000) + 100,
        comments: Math.floor(Math.random() * 30) + 1,
        likes: Math.floor(Math.random() * 100) + 1
    };
}
---

<section class="recent-section">
    <div class="section-header">
        <div class="section-icon">ğŸ”„</div>
        <h2 class="section-title">æœ€æ–°è¨˜äº‹</h2>
    </div>
    <div class="article-list">
        {recentArticles.map((article, index) => {
            const stats = generateMockStats();
            const stars = generateStarRating(article.data.stars || 4.0);
            const readTime = calculateReadTime(article.body);
            const emoji = getEmojiForTags(article.data.tags || []);
            const articleUrl = `${basePath}/articles/${article.slug}`.replace(/\/+/g, '/');
            
            return (
                <RecentCard
                    article={article}
                    index={index}
                    basePath={basePath}
                    stats={stats}
                    stars={stars}
                    readTime={readTime}
                    emoji={emoji}
                    articleUrl={articleUrl}
                />
            );
        })}
    </div>
</section>

<script>
    // Favorite functionality
    function toggleFavorite(button: HTMLElement): void {
        const articleId = button.getAttribute("data-article");
        if (!articleId) return;

        const isActive = button.classList.contains("active");

        if (isActive) {
            button.classList.remove("active");
            button.innerHTML = "â™¡";
            removeFavorite(articleId);
        } else {
            button.classList.add("active");
            button.innerHTML = "â™¥";
            addFavorite(articleId);
        }
    }

    // Make toggleFavorite globally available
    (window as any).toggleFavorite = toggleFavorite;

    function addFavorite(articleId: string): void {
        let favorites: string[] = JSON.parse(
            localStorage.getItem("favorites") || "[]",
        );
        if (!favorites.includes(articleId)) {
            favorites.push(articleId);
            localStorage.setItem("favorites", JSON.stringify(favorites));
        }
    }

    function removeFavorite(articleId: string): void {
        let favorites: string[] = JSON.parse(
            localStorage.getItem("favorites") || "[]",
        );
        favorites = favorites.filter((id) => id !== articleId);
        localStorage.setItem("favorites", JSON.stringify(favorites));
    }

    // Load favorites on page load
    function loadFavorites(): void {
        const favorites: string[] = JSON.parse(
            localStorage.getItem("favorites") || "[]",
        );
        favorites.forEach((articleId) => {
            const button = document.querySelector(
                `[data-article="${articleId}"]`,
            ) as HTMLElement;
            if (button) {
                button.classList.add("active");
                button.innerHTML = "â™¥";
            }
        });
    }
    // Initialize everything when DOM is loaded
    document.addEventListener("DOMContentLoaded", () => {
        loadFavorites();
    });
</script>

<style>
    .recent-section {
        border-top: 1px solid var(--border);
    }
    
    .section-header {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 2rem;
        padding: 0 1.5rem;
        padding-top: 1.5rem;
    }
    
    .section-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--text-primary);
    }
    
    .section-icon {
        width: 40px;
        height: 40px;
        background: var(--gradient);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.2rem;
    }
    
    .article-list {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
        padding: 1.5rem;
    }
    
    /* Fade-in animation for cards - keeping timing for the list */
    .article-list :global(.fade-in-card:nth-child(1)) {
        transition-delay: 0s;
    }
    
    .article-list :global(.fade-in-card:nth-child(2)) {
        transition-delay: 0.1s;
    }
    
    .article-list :global(.fade-in-card:nth-child(3)) {
        transition-delay: 0.2s;
    }
    
    .article-list :global(.fade-in-card:nth-child(4)) {
        transition-delay: 0.3s;
    }
    
    .article-list :global(.fade-in-card:nth-child(5)) {
        transition-delay: 0.4s;
    }
    
    @media (max-width: 768px) {
        .recent-item {
            flex-direction: column;
            align-items: flex-start;
        }
    }
</style>
